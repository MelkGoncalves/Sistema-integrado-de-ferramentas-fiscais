<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Extrator de Informa√ß√µes para Pedido de Restitui√ß√£o</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd8;
      --secondary: #764ba2;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--dark);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2.2em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .card {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 30px;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .card h2 {
      color: var(--dark);
      margin-bottom: 20px;
      font-size: 1.4em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 1em;
      font-weight: 600;
      color: var(--gray);
      transition: var(--transition);
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover {
      color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: rgba(102, 126, 234, 0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
      margin-bottom: 15px;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: -9999px;
    }

    .file-input-label {
      display: block;
      padding: 25px;
      background: var(--light);
      border: 2px dashed var(--primary);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-label:hover {
      background: #e9ecef;
      border-color: var(--secondary);
      transform: translateY(-2px);
    }

    .file-input-label.has-file {
      border-style: solid;
      background: #e7f3ff;
      border-color: #0066cc;
    }

    .files-list {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 10px;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: var(--light);
      border-radius: 6px;
      margin-bottom: 8px;
      transition: var(--transition);
    }

    .file-item:hover {
      background: #e9ecef;
    }

    .file-item-name {
      flex: 1;
      color: var(--dark);
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-item-remove {
      background: var(--danger);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .file-item-remove:hover {
      background: #c82333;
      transform: scale(1.05);
    }

    .btn {
      padding: 15px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      font-weight: 600;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--gray) 0%, #5a6268 100%);
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
      color: white;
    }

    .btn-success:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #fd7e14 100%);
      color: var(--dark);
    }

    .btn-warning:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #e4606d 100%);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .btn:disabled::before {
      display: none;
    }

    .results {
      background: white;
      padding: 30px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      animation: fadeIn 0.5s ease;
    }

    .results h2 {
      color: var(--dark);
      margin-bottom: 25px;
      font-size: 1.4em;
      border-bottom: 3px solid var(--primary);
      padding-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .editable-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    .editable-table th {
      background: var(--primary);
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .editable-table td {
      padding: 10px 12px;
      border: 1px solid #dee2e6;
    }

    .editable-table tr:nth-child(even) {
      background: var(--light);
    }

    .editable-table tr:hover {
      background: #e9ecef;
    }

    .editable-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 0.9em;
      transition: var(--transition);
    }

    .editable-table input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 8px;
    }

    .pdf-section {
      margin-bottom: 30px;
      padding: 20px;
      background: var(--light);
      border-radius: 8px;
      border-left: 5px solid var(--primary);
      transition: var(--transition);
    }

    .pdf-section:hover {
      transform: translateX(5px);
    }

    .pdf-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
    }

    .pdf-section-title {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--dark);
    }

    .pdf-section-number {
      background: var(--primary);
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
    }

    .field {
      margin-bottom: 12px;
      padding: 12px;
      background: white;
      border-left: 3px solid var(--primary);
      border-radius: 6px;
      transition: var(--transition);
    }

    .field:hover {
      background: var(--light);
      transform: translateX(5px);
    }

    .field label {
      font-weight: 600;
      color: var(--dark);
      display: block;
      margin-bottom: 5px;
      font-size: 0.85em;
    }

    .field-value {
      color: var(--primary);
      font-size: 1em;
      font-weight: 500;
      word-break: break-word;
    }

    .field-value.not-found {
      color: var(--danger);
      font-style: italic;
    }

    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 4px solid;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border-left-color: var(--danger);
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border-left-color: var(--success);
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border-left-color: var(--info);
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border-left-color: var(--warning);
    }

    .loading {
      text-align: center;
      padding: 30px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e9ecef;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9em;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions button {
      flex: 1;
      min-width: 150px;
    }

    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      flex: 1;
      min-width: 150px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    .info-box {
      background: #e7f3ff;
      border-left: 4px solid #0066cc;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      color: #0066cc;
      margin-bottom: 10px;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-box ul {
      margin-left: 20px;
      color: var(--dark);
    }

    .info-box li {
      margin-bottom: 5px;
    }

    .view-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 10px;
    }

    .view-toggle button {
      padding: 10px 20px;
      border: 2px solid var(--primary);
      background: white;
      color: var(--primary);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 600;
    }

    .view-toggle button.active {
      background: var(--primary);
      color: white;
    }

    .view-toggle button:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 3em;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 1.1em;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.5em;
      }

      .card {
        padding: 20px;
      }

      .actions {
        flex-direction: column;
      }

      .actions button {
        min-width: 100%;
      }

      .stats {
        flex-direction: column;
      }

      .tabs {
        flex-direction: column;
      }

      .table-container {
        max-height: 400px;
      }

      .pdf-section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <div style="position: fixed; top: 20px; left: 20px; z-index: 1000;">
    <a href="index.html" style="display: inline-block; background: #667eea; color: white; padding: 12px 20px; border-radius: 25px; text-decoration: none; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease; border: 2px solid white;">
        üè† Voltar ao In√≠cio
    </a>
  </div>

  <div class="container">
    <h1>
      <span>üìÑ</span>
      Extrator para Pedido de Restitui√ß√£o
    </h1>

    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('extract')">
          <span>üì•</span>
          Extrair de PDFs
        </button>
        <button class="tab" onclick="switchTab('edit')">
          <span>‚úèÔ∏è</span>
          Editar Planilha
        </button>
      </div>

      <div id="extractTab" class="tab-content active">
        <h2><span>üìÑ</span> Upload de PDFs (M√∫ltiplos Arquivos)</h2>
        
        <div class="info-box">
          <h3><span>‚ÑπÔ∏è</span> Como usar:</h3>
          <ul>
            <li>Selecione um ou mais arquivos PDF para pedido de restitui√ß√£o</li>
            <li>O sistema extrair√° automaticamente as informa√ß√µes relevantes</li>
            <li>Revise os dados extra√≠dos e exporte no formato desejado</li>
          </ul>
        </div>
        
        <div class="file-input-wrapper">
          <input type="file" id="pdfUpload" accept=".pdf" multiple />
          <label for="pdfUpload" class="file-input-label" id="fileLabel">
            <span>üìÅ Clique aqui ou arraste m√∫ltiplos arquivos PDF</span>
          </label>
        </div>
        <div class="files-list" id="filesList"></div>
        <button onclick="processPDFs()" id="processBtn" class="btn btn-primary">
          <span>üîç</span>
          Extrair Informa√ß√µes de Todos os Arquivos
        </button>
      </div>

      <div id="editTab" class="tab-content">
        <h2><span>üìä</span> Upload de Planilha Excel para Edi√ß√£o</h2>
        <div class="info-box">
          <h3><span>‚ÑπÔ∏è</span> Como usar:</h3>
          <ul>
            <li>Primeiro, extraia os dados dos PDFs e exporte para Excel</li>
            <li>Fa√ßa upload da planilha gerada para edit√°-la aqui</li>
            <li>Edite os valores diretamente na tabela</li>
            <li>Exporte novamente com as altera√ß√µes</li>
          </ul>
        </div>
        <div class="file-input-wrapper">
          <input type="file" id="excelUpload" accept=".xlsx,.xls" />
          <label for="excelUpload" class="file-input-label" id="excelLabel">
            <span>üìä Clique aqui para fazer upload da planilha Excel</span>
          </label>
        </div>
        <button onclick="loadExcel()" id="loadExcelBtn" class="btn btn-primary" style="display: none">
          <span>üìù</span>
          Carregar Planilha para Edi√ß√£o
        </button>
      </div>
    </div>

    <div id="results" class="results" style="display: none">
      <h2 id="resultsTitle">
        <span>üìã</span>
        Informa√ß√µes Extra√≠das
      </h2>
      
      <div class="stats" id="statsSection"></div>
      
      <div class="view-toggle" id="viewToggle" style="display: none">
        <button onclick="switchView('cards')" id="cardsViewBtn" class="active">
          <span>üÉè</span> Visualiza√ß√£o em Cart√µes
        </button>
        <button onclick="switchView('table')" id="tableViewBtn">
          <span>üìä</span> Visualiza√ß√£o em Tabela
        </button>
      </div>

      <div id="cardsView">
        <div id="extractedData"></div>
      </div>

      <div id="tableView" style="display: none">
        <div class="table-container">
          <table class="editable-table" id="editableTable"></table>
        </div>
      </div>

      <div class="actions">
        <button onclick="exportToPDF()" class="btn btn-danger" id="pdfBtn">
          <span>üìÑ</span> Exportar PDF
        </button>
        <button onclick="exportToExcel()" class="btn btn-success" id="exportBtn">
          <span>üìä</span> Exportar Excel
        </button>
        <button onclick="exportToCSV()" class="btn btn-secondary" id="csvBtn">
          <span>üíæ</span> Exportar CSV
        </button>
        <button onclick="copyToClipboard()" class="btn btn-warning" id="copyBtn">
          <span>üìã</span> Copiar Dados
        </button>
        <button onclick="reset()" class="btn btn-secondary">
          <span>üîÑ</span> Novo Upload
        </button>
      </div>
    </div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    let allExtractedData = [];
    let selectedFiles = [];
    let currentMode = "extract";
    let editableData = [];
    let currentView = "cards";

    const fileInput = document.getElementById("pdfUpload");
    const excelInput = document.getElementById("excelUpload");
    const fileLabel = document.getElementById("fileLabel");
    const excelLabel = document.getElementById("excelLabel");
    const filesList = document.getElementById("filesList");
    const processBtn = document.getElementById("processBtn");
    const loadExcelBtn = document.getElementById("loadExcelBtn");
    const viewToggle = document.getElementById("viewToggle");
    const cardsViewBtn = document.getElementById("cardsViewBtn");
    const tableViewBtn = document.getElementById("tableViewBtn");

    function switchTab(tab) {
      document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));

      if (tab === "extract") {
        document.querySelectorAll(".tab")[0].classList.add("active");
        document.getElementById("extractTab").classList.add("active");
        currentMode = "extract";
      } else {
        document.querySelectorAll(".tab")[1].classList.add("active");
        document.getElementById("editTab").classList.add("active");
        currentMode = "edit";
      }
    }

    function switchView(view) {
      currentView = view;
      
      if (view === "cards") {
        document.getElementById("cardsView").style.display = "block";
        document.getElementById("tableView").style.display = "none";
        cardsViewBtn.classList.add("active");
        tableViewBtn.classList.remove("active");
      } else {
        document.getElementById("cardsView").style.display = "none";
        document.getElementById("tableView").style.display = "block";
        cardsViewBtn.classList.remove("active");
        tableViewBtn.classList.add("active");
        
        if (currentMode === "extract") {
          displayExtractedDataAsTable();
        }
      }
    }

    fileInput.addEventListener("change", (e) => {
      addFiles(Array.from(e.target.files));
    });

    fileLabel.addEventListener("dragover", (e) => {
      e.preventDefault();
      fileLabel.style.borderColor = "#764ba2";
      fileLabel.style.transform = "scale(1.02)";
    });

    fileLabel.addEventListener("dragleave", () => {
      fileLabel.style.borderColor = "#667eea";
      fileLabel.style.transform = "scale(1)";
    });

    fileLabel.addEventListener("drop", (e) => {
      e.preventDefault();
      fileLabel.style.borderColor = "#667eea";
      fileLabel.style.transform = "scale(1)";
      if (e.dataTransfer.files.length > 0) {
        addFiles(Array.from(e.dataTransfer.files));
      }
    });

    excelInput.addEventListener("change", (e) => {
      if (e.target.files.length > 0) {
        excelLabel.classList.add("has-file");
        excelLabel.innerHTML = `<span>üìä ${e.target.files[0].name}</span>`;
        loadExcelBtn.style.display = "block";
      }
    });

    function addFiles(files) {
      const pdfFiles = files.filter(
        (f) => f.type === "application/pdf" || f.name.toLowerCase().endsWith(".pdf")
      );

      pdfFiles.forEach((file) => {
        if (!selectedFiles.find((f) => f.name === file.name && f.size === file.size)) {
          selectedFiles.push(file);
        }
      });

      updateFilesList();

      if (pdfFiles.length < files.length) {
        showAlert("Apenas arquivos PDF foram adicionados.", "warning");
      }
    }

    function updateFilesList() {
      if (selectedFiles.length === 0) {
        filesList.innerHTML = '<div class="empty-state"><span>üìÑ</span><p>Nenhum arquivo selecionado</p></div>';
        fileLabel.classList.remove("has-file");
        return;
      }

      fileLabel.classList.add("has-file");
      let html = '<div style="margin-bottom: 10px; font-weight: 600; color: #495057;">Arquivos Selecionados:</div>';

      selectedFiles.forEach((file, index) => {
        html += `
          <div class="file-item">
            <span class="file-item-name">üìÑ ${file.name} (${formatFileSize(file.size)})</span>
            <button class="file-item-remove" onclick="removeFile(${index})">
              <span>‚úï</span> Remover
            </button>
          </div>
        `;
      });

      filesList.innerHTML = html;
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updateFilesList();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + " B";
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
      return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    }

    function extractPattern(text, regex) {
      const match = text.match(regex);
      return match ? match[1].trim() : null;
    }

   function extractFields(text) {
  const fields = {
    CNPJ: extractPattern(text, /CNPJ[:\s]+(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/i),

    "N√∫mero do PER/DCOMP": extractPattern(text, /(\d{5}\.\d{5}\.\d{6}\.\d\.\d\.\d{2}-\d{4})/),

    Compet√™ncia: extractPattern(text, /Compet[√™e]ncia[:\s]+([^\s]+)/i),

    "Cr√©dito Original na Data da Entrega": (function () {
      let match = text.match(/Cr[√©e]dito\s*Original\s*na\s*Data\s*da\s*Entrega[\s:‚Äì-]*([\d.,]+)/i);
      if (!match) {
        match = text.match(/([\d]{1,3}(?:\.\d{3})*,\d{2})\s*Cr[√©e]dito\s*Original\s*na\s*Data\s*da\s*Entrega/i);
      }
      return match ? match[1].trim() : null;
    })(),

    "N√∫mero da EFD-REINF": extractPattern(text, /N[√∫u]mero.*?EFD.?REINF[:\s]*([^\s]+)/i),

    // üîπ Aqui est√° o campo correto da data de fechamento
    "Data de Fechamento EFD-REINF": (function () {
      const match = text.match(/Data.*?Fechamento.*?EFD[-\s]?REINF[:\s]*\n?\s*(\d{2}\/\d{2}\/\d{4})/i)
        || text.match(/Data\s*de\s*Fechamento\s*EFD[-\s]?REINF[\s\S]{0,80}?(\d{2}\/\d{2}\/\d{4})/i);
      return match ? match[1].trim() : "N√£o encontrado";
    })(),

    "Valor das Reten√ß√µes": extractPattern(text, /Valor.*?Reten[√ßc][√µo]es[:\s]*([\d.,]+)/i),
  };

  return fields;
}

    async function processPDFs() {
      if (selectedFiles.length === 0) {
        showAlert("Por favor, selecione pelo menos um arquivo PDF.", "warning");
        return;
      }

      currentMode = "extract";
      const resultsDiv = document.getElementById("results");
      const extractedDiv = document.getElementById("extractedData");

      document.getElementById("resultsTitle").textContent = "Informa√ß√µes Extra√≠das";
      viewToggle.style.display = "flex";

      extractedDiv.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Processando ${selectedFiles.length} arquivo(s)...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
          </div>
        </div>
      `;
      resultsDiv.style.display = "block";
      processBtn.disabled = true;
      allExtractedData = [];

      try {
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const progress = Math.round(((i + 1) / selectedFiles.length) * 100);

          const progressFill = document.getElementById("progressFill");
          if (progressFill) {
            progressFill.style.width = progress + "%";
            progressFill.textContent = progress + "%";
          }

          try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            let fullText = "";

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
              const page = await pdf.getPage(pageNum);
              const textContent = await page.getTextContent();
              const pageText = textContent.items.map((item) => item.str).join(" ");
              fullText += pageText + "\n";
            }

            fullText = fullText.replace(/\s+/g, " ").trim();
            const extractedFields = extractFields(fullText);

            allExtractedData.push({
              fileName: file.name,
              data: extractedFields,
              success: true,
            });
          } catch (error) {
            allExtractedData.push({
              fileName: file.name,
              data: null,
              success: false,
              error: error.message,
            });
          }
        }

        displayAllResults();
        showAlert(`Processamento conclu√≠do! ${allExtractedData.filter(d => d.success).length} de ${allExtractedData.length} arquivos processados com sucesso.`, "success");
      } catch (error) {
        showAlert(`Erro geral ao processar PDFs: ${error.message}`, "error");
      } finally {
        processBtn.disabled = false;
      }
    }

    async function loadExcel() {
      const file = excelInput.files[0];
      if (!file) {
        showAlert("Por favor, selecione um arquivo Excel.", "warning");
        return;
      }

      currentMode = "edit";
      const resultsDiv = document.getElementById("results");
      document.getElementById("resultsTitle").textContent = "Editar Planilha";
      document.getElementById("statsSection").innerHTML = "";
      viewToggle.style.display = "none";

      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });

        editableData = [];

        const validSheets = workbook.SheetNames.filter((sheetName) => {
          const normalized = sheetName.toLowerCase().trim();
          return !(
            normalized === "resumo" ||
            normalized === "üìä resumo" ||
            normalized === "dados consolidados" ||
            normalized.startsWith("resumo") ||
            normalized.includes("consolidado")
          );
        });

        validSheets.forEach((sheetName) => {
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          const dataStartIndex = jsonData.findIndex(
            (row) => row[0] === "Campo" && row[1] === "Valor"
          );

          if (dataStartIndex !== -1 && jsonData.length > dataStartIndex + 1) {
            const record = {
              sheetName: sheetName,
              data: {},
            };

            const dataRows = jsonData.slice(dataStartIndex + 1);

            dataRows.forEach((row) => {
              if (row[0] && row[0].toString().trim() !== "") {
                record.data[row[0]] = row[1] || "";
              }
            });

            if (Object.keys(record.data).length > 0) {
              editableData.push(record);
            }
          }
        });

        if (editableData.length === 0) {
          showAlert("Nenhum dado v√°lido encontrado. Certifique-se de que est√° usando uma planilha exportada por este sistema.", "warning");
          return;
        }

        displayEditableTable();
        resultsDiv.style.display = "block";
        document.getElementById("cardsView").style.display = "none";
        document.getElementById("tableView").style.display = "block";
        currentView = "table";

        showAlert(`Planilha carregada com sucesso! ${editableData.length} arquivo(s) encontrado(s).`, "success");
      } catch (error) {
        showAlert("Erro ao carregar planilha: " + error.message, "error");
      }
    }

    function displayAllResults() {
      const extractedDiv = document.getElementById("extractedData");
      const statsSection = document.getElementById("statsSection");
      const successful = allExtractedData.filter(d => d.success).length;
      const failed = allExtractedData.length - successful;

      statsSection.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${allExtractedData.length}</div>
          <div class="stat-label">Total de Arquivos</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${successful}</div>
          <div class="stat-label">Processados com Sucesso</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${failed}</div>
          <div class="stat-label">Falhas</div>
        </div>
      `;

      if (allExtractedData.length === 0) {
        extractedDiv.innerHTML = '<div class="empty-state"><span>üìÑ</span><p>Nenhum dado extra√≠do</p></div>';
        return;
      }

      let html = "";

      allExtractedData.forEach((fileData, index) => {
        if (!fileData.success) {
          html += `
            <div class="pdf-section">
              <div class="pdf-section-header">
                <div class="pdf-section-title">${fileData.fileName}</div>
                <div class="pdf-section-number" style="background: var(--danger);">Erro</div>
              </div>
              <div class="alert alert-error">
                <span>‚ùå</span>
                <div>Erro ao processar arquivo: ${fileData.error}</div>
              </div>
            </div>
          `;
          return;
        }

        html += `
          <div class="pdf-section">
            <div class="pdf-section-header">
              <div class="pdf-section-title">${fileData.fileName}</div>
              <div class="pdf-section-number">${index + 1}</div>
            </div>
        `;

        const fields = [
          "CNPJ",
          "N√∫mero do PER/DCOMP",
          "Compet√™ncia",
          "Cr√©dito Original na Data da Entrega",
          "N√∫mero da EFD-REINF",
          "Data de Fechamento EFD-REINF",
          "Valor das Reten√ß√µes"
        ];

        fields.forEach((fieldName) => {
          const value = fileData.data[fieldName];
          html += `
            <div class="field">
              <label>${fieldName}:</label>
              <div class="field-value ${!value ? "not-found" : ""}">
                ${value || "N√£o encontrado"}
              </div>
            </div>
          `;
        });

        html += `</div>`;
      });

      extractedDiv.innerHTML = html;
    }

    function displayExtractedDataAsTable() {
      const table = document.getElementById("editableTable");
      if (allExtractedData.length === 0) {
        table.innerHTML = "";
        return;
      }

      const fields = [
        "CNPJ",
        "N√∫mero do PER/DCOMP",
        "Compet√™ncia",
        "Cr√©dito Original na Data da Entrega",
        "N√∫mero da EFD-REINF",
        "Data de Fechamento EFD-REINF",
        "Valor das Reten√ß√µes"
      ];

      let html = `
        <thead>
          <tr>
            <th>Arquivo</th>
            ${fields.map(field => `<th>${field}</th>`).join("")}
          </tr>
        </thead>
        <tbody>
      `;

      allExtractedData.forEach((fileData) => {
        if (!fileData.success) return;

        html += `<tr><td>${fileData.fileName}</td>`;
        
        fields.forEach(field => {
          const value = fileData.data[field] || "";
          html += `<td><input type="text" value="${value}" data-field="${field}" data-file="${fileData.fileName}" /></td>`;
        });
        
        html += `</tr>`;
      });

      html += `</tbody>`;
      table.innerHTML = html;

      const inputs = table.querySelectorAll("input");
      inputs.forEach(input => {
        input.addEventListener("change", (e) => {
          const field = e.target.getAttribute("data-field");
          const fileName = e.target.getAttribute("data-file");
          const fileData = allExtractedData.find(d => d.fileName === fileName);
          
          if (fileData && fileData.data) {
            fileData.data[field] = e.target.value;
          }
        });
      });
    }

    function displayEditableTable() {
      const table = document.getElementById("editableTable");
      
      if (editableData.length === 0) {
        table.innerHTML = "";
        return;
      }

      const allFields = new Set();
      editableData.forEach(record => {
        Object.keys(record.data).forEach(field => allFields.add(field));
      });

      const fields = Array.from(allFields);

      let html = `
        <thead>
          <tr>
            <th>Arquivo</th>
            ${fields.map(field => `<th>${field}</th>`).join("")}
          </tr>
        </thead>
        <tbody>
      `;

      editableData.forEach((record) => {
        html += `<tr><td>${record.sheetName}</td>`;
        
        fields.forEach(field => {
          const value = record.data[field] || "";
          html += `<td><input type="text" value="${value}" data-field="${field}" data-file="${record.sheetName}" /></td>`;
        });
        
        html += `</tr>`;
      });

      html += `</tbody>`;
      table.innerHTML = html;

      const inputs = table.querySelectorAll("input");
      inputs.forEach(input => {
        input.addEventListener("change", (e) => {
          const field = e.target.getAttribute("data-field");
          const fileName = e.target.getAttribute("data-file");
          const record = editableData.find(d => d.sheetName === fileName);
          
          if (record && record.data) {
            record.data[field] = e.target.value;
          }
        });
      });
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;

      doc.setFontSize(16);
      doc.text("Relat√≥rio de Informa√ß√µes Extra√≠das", 20, y);
      y += 15;

      doc.setFontSize(10);

      allExtractedData.forEach((fileData, index) => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }

        doc.setFont(undefined, "bold");
        doc.text(`Arquivo: ${fileData.fileName}`, 20, y);
        y += 7;

        doc.setFont(undefined, "normal");
        const fields = [
          "CNPJ",
          "N√∫mero do PER/DCOMP",
          "Compet√™ncia",
          "Cr√©dito Original na Data da Entrega",
          "N√∫mero da EFD-REINF",
          "Data de Fechamento EFD-REINF",
          "Valor das Reten√ß√µes"
        ];

        fields.forEach(field => {
          const value = fileData.data[field] || "N√£o encontrado";
          const text = `${field}: ${value}`;
          
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          
          doc.text(text, 25, y);
          y += 5;
        });

        y += 5;
      });

      doc.save("informacoes_extraidas.pdf");
      showAlert("PDF exportado com sucesso!", "success");
    }

    function exportToExcel() {
      const wb = XLSX.utils.book_new();

      allExtractedData.forEach((fileData, index) => {
        const fileName = fileData.fileName.replace(/[\\/:*?"<>|]/g, "_");
        const sheetName = fileName.length > 31 ? fileName.substring(0, 31) : fileName;

        const data = [
          ["Campo", "Valor"],
          ["Arquivo", fileData.fileName]
        ];

        const fields = [
          "CNPJ",
          "N√∫mero do PER/DCOMP",
          "Compet√™ncia",
          "Cr√©dito Original na Data da Entrega",
          "N√∫mero da EFD-REINF",
          "Data de Fechamento EFD-REINF",
          "Valor das Reten√ß√µes"
        ];

        fields.forEach(field => {
          data.push([field, fileData.data[field] || ""]);
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
      });

      const dataToExport = currentMode === "extract" ? allExtractedData : editableData;
      const fileName = currentMode === "extract" ? "informacoes_extraidas.xlsx" : "planilha_editada.xlsx";

      XLSX.writeFile(wb, fileName);
      showAlert("Arquivo Excel exportado com sucesso!", "success");
    }

    function exportToCSV() {
      const fields = [
        "Arquivo",
        "CNPJ",
        "N√∫mero do PER/DCOMP",
        "Compet√™ncia",
        "Cr√©dito Original na Data da Entrega",
        "N√∫mero da EFD-REINF",
        "Data de Fechamento EFD-REINF",
        "Valor das Reten√ß√µes"
      ];

      let csvContent = fields.join(";") + "\n";

      allExtractedData.forEach(fileData => {
        if (!fileData.success) return;

        const row = [
          fileData.fileName,
          fileData.data["CNPJ"] || "",
          fileData.data["N√∫mero do PER/DCOMP"] || "",
          fileData.data["Compet√™ncia"] || "",
          fileData.data["Cr√©dito Original na Data da Entrega"] || "",
          fileData.data["N√∫mero da EFD-REINF"] || "",
          fileData.data["Data de Fechamento EFD-REINF"] || "",
          fileData.data["Valor das Reten√ß√µes"] || ""
        ];

        csvContent += row.join(";") + "\n";
      });

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "informacoes_extraidas.csv");
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showAlert("Arquivo CSV exportado com sucesso!", "success");
    }

    function copyToClipboard() {
      const dataToCopy = allExtractedData.map(fileData => {
        if (!fileData.success) return `Arquivo: ${fileData.fileName} - ERRO`;

        const fields = [
          "CNPJ",
          "N√∫mero do PER/DCOMP",
          "Compet√™ncia",
          "Cr√©dito Original na Data da Entrega",
          "N√∫mero da EFD-REINF",
          "Data de Fechamento EFD-REINF",
          "Valor das Reten√ß√µes"
        ];

        const values = fields.map(field => {
          const value = fileData.data[field] || "N√£o encontrado";
          return `${field}: ${value}`;
        });

        return `Arquivo: ${fileData.fileName}\n${values.join("\n")}`;
      }).join("\n\n");

      navigator.clipboard.writeText(dataToCopy)
        .then(() => {
          showAlert("Dados copiados para a √°rea de transfer√™ncia!", "success");
        })
        .catch(err => {
          showAlert("Erro ao copiar dados: " + err, "error");
        });
    }

    function reset() {
      selectedFiles = [];
      allExtractedData = [];
      editableData = [];
      fileInput.value = "";
      excelInput.value = "";
      filesList.innerHTML = "";
      fileLabel.classList.remove("has-file");
      excelLabel.classList.remove("has-file");
      loadExcelBtn.style.display = "none";
      document.getElementById("results").style.display = "none";
      showAlert("Sistema reiniciado. Fa√ßa um novo upload.", "info");
    }

    function showAlert(message, type) {
      const alertDiv = document.createElement("div");
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `
        <span>${type === "success" ? "‚úÖ" : type === "error" ? "‚ùå" : type === "warning" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è"}</span>
        <div>${message}</div>
      `;

      const container = document.querySelector(".container");
      container.insertBefore(alertDiv, container.firstChild);

      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>